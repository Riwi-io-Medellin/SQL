<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD Usuarios - Frontend Est√°tico con Supabase</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .form-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        input[type="text"] {
            width: 200px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-danger { background: #dc3545; color: white; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
        }
        .config-info {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üë• CRUD Usuarios con Supabase REST API</h1>
        
        <div class="config-info">
            <strong>üìã Configuraci√≥n requerida:</strong><br>
            1. Tabla ya existe: <code>public.users (id, username, role, created_at)</code> ‚úÖ<br>
            2. Configurar RLS: <code>ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;</code><br>
            3. Pol√≠tica permisiva: <code>CREATE POLICY "Allow all" ON public.users FOR ALL USING (true);</code><br>
            4. Actualizar las variables SUPABASE_URL y SUPABASE_ANON_KEY abajo
        </div>

        <!-- Configuraci√≥n -->
        <div class="form-section">
            <h3>üîß Configuraci√≥n de Supabase</h3>
            <input type="text" id="supabaseUrl" placeholder="https://tu-proyecto.supabase.co" style="width: 300px;">
            <input type="text" id="supabaseKey" placeholder="Tu anon key" style="width: 300px;">
            <button class="btn-primary" onclick="saveConfig()">Guardar Config</button>
        </div>

        <!-- Crear Usuario -->
        <div class="form-section">
            <h3>‚ûï Crear Nuevo Usuario</h3>
            <input type="text" id="newUsername" placeholder="Nombre de usuario" style="width: 200px;">
            <select id="newRole" style="width: 150px; padding: 8px; margin: 5px; border: 1px solid #ccc; border-radius: 4px;">
                <option value="member">Member</option>
                <option value="admin">Admin</option>
                <option value="editor">Editor</option>
            </select>
            <button class="btn-success" onclick="createUser()">Crear Usuario</button>
        </div>

        <!-- Lista de Usuarios -->
        <div class="form-section">
            <h3>üë• Lista de Usuarios</h3>
            <button class="btn-primary" onclick="loadUsers()">üîÑ Recargar</button>
            <table id="usersTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Creado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="usersBody">
                    <tr><td colspan="5">Haz clic en "Recargar" para ver los usuarios</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Variables globales para la configuraci√≥n
        let SUPABASE_URL = '';
        let SUPABASE_ANON_KEY = '';

        // Cargar configuraci√≥n desde localStorage
        function loadConfig() {
            SUPABASE_URL = localStorage.getItem('supabase_url') || '';
            SUPABASE_ANON_KEY = localStorage.getItem('supabase_key') || '';
            
            if (SUPABASE_URL) document.getElementById('supabaseUrl').value = SUPABASE_URL;
            if (SUPABASE_ANON_KEY) document.getElementById('supabaseKey').value = SUPABASE_ANON_KEY;
        }

        // Guardar configuraci√≥n
        function saveConfig() {
            SUPABASE_URL = document.getElementById('supabaseUrl').value.trim();
            SUPABASE_ANON_KEY = document.getElementById('supabaseKey').value.trim();
            
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                alert('‚ùå Por favor completa ambos campos de configuraci√≥n');
                return;
            }
            
            localStorage.setItem('supabase_url', SUPABASE_URL);
            localStorage.setItem('supabase_key', SUPABASE_ANON_KEY);
            alert('‚úÖ Configuraci√≥n guardada correctamente');
        }

        // Funci√≥n auxiliar para hacer peticiones a Supabase
        async function supabaseFetch(endpoint, options = {}) {
            if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                throw new Error('Configuraci√≥n de Supabase incompleta');
            }

            const url = `${SUPABASE_URL}/rest/v1${endpoint}`;
            const headers = {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation',
                ...options.headers
            };

            const response = await fetch(url, {
                ...options,
                headers
            });

            if (!response.ok) {
                const error = await response.text();
                throw new Error(`HTTP ${response.status}: ${error}`);
            }

            return response.json();
        }

        // CREATE - Crear nuevo usuario
        async function createUser() {
            const username = document.getElementById('newUsername').value.trim();
            const role = document.getElementById('newRole').value;
            
            if (!username) {
                alert('‚ùå Por favor ingresa un nombre de usuario');
                return;
            }

            try {
                await supabaseFetch('/users', {
                    method: 'POST',
                    body: JSON.stringify({ username, role })
                });
                
                alert('‚úÖ Usuario creado exitosamente');
                document.getElementById('newUsername').value = '';
                document.getElementById('newRole').value = 'member';
                loadUsers(); // Recargar la lista
            } catch (error) {
                alert(`‚ùå Error al crear usuario: ${error.message}`);
            }
        }

        // READ - Cargar todos los usuarios
        async function loadUsers() {
            try {
                const users = await supabaseFetch('/users?select=*&order=id');
                renderUsers(users);
            } catch (error) {
                alert(`‚ùå Error al cargar usuarios: ${error.message}`);
            }
        }

        // Renderizar usuarios en la tabla
        function renderUsers(users) {
            const tbody = document.getElementById('usersBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No hay usuarios para mostrar</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const createdDate = new Date(user.created_at).toLocaleDateString('es-ES');
                return `
                    <tr>
                        <td>${user.id}</td>
                        <td>${user.username}</td>
                        <td><span style="background: ${getRoleColor(user.role)}; padding: 2px 6px; border-radius: 3px; font-size: 12px;">${user.role}</span></td>
                        <td>${createdDate}</td>
                        <td>
                            <button class="btn-warning" onclick="editUser(${user.id}, '${user.username}', '${user.role}')">‚úèÔ∏è Editar</button>
                            <button class="btn-danger" onclick="deleteUser(${user.id})">üóëÔ∏è Eliminar</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Funci√≥n auxiliar para colores de roles
        function getRoleColor(role) {
            switch(role) {
                case 'admin': return '#dc3545';
                case 'editor': return '#ffc107';
                case 'member': return '#28a745';
                default: return '#6c757d';
            }
        }

        // UPDATE - Editar usuario (con prompt)
        async function editUser(id, currentUsername, currentRole) {
            const newUsername = prompt('Nuevo nombre de usuario:', currentUsername);
            
            if (newUsername === null) return; // Usuario cancel√≥
            if (newUsername.trim() === '') {
                alert('‚ùå El nombre de usuario no puede estar vac√≠o');
                return;
            }

            // Prompt para el rol
            const roles = ['member', 'admin', 'editor'];
            let newRole = prompt(`Nuevo rol (${roles.join(', ')}):`, currentRole);
            
            if (newRole === null) return; // Usuario cancel√≥
            if (!roles.includes(newRole)) {
                alert('‚ùå Rol inv√°lido. Debe ser: member, admin o editor');
                return;
            }

            try {
                await supabaseFetch(`/users?id=eq.${id}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ 
                        username: newUsername.trim(),
                        role: newRole 
                    })
                });
                
                alert('‚úÖ Usuario actualizado exitosamente');
                loadUsers(); // Recargar la lista
            } catch (error) {
                alert(`‚ùå Error al actualizar usuario: ${error.message}`);
            }
        }

        // DELETE - Eliminar usuario
        async function deleteUser(id) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este usuario?')) {
                return;
            }

            try {
                await supabaseFetch(`/users?id=eq.${id}`, {
                    method: 'DELETE'
                });
                
                alert('‚úÖ Usuario eliminado exitosamente');
                loadUsers(); // Recargar la lista
            } catch (error) {
                alert(`‚ùå Error al eliminar usuario: ${error.message}`);
            }
        }

        // Cargar configuraci√≥n al iniciar
        window.onload = function() {
            loadConfig();
        };
    </script>
</body>
</html>
